#user  nobody;
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #开启gzip 
    gzip on;  
    gzip_proxied any;  
    gzip_types text/plain text/xml text/css application/x-javascript;  
    gzip_vary on;

    server {
        listen       80;
        server_name  localhost;
        root   /usr/share/nginx/html/;
        index  index.html index.htm;
        
        location / {
            
            
            #try_files $uri$args $uri$args/ $uri/ /index.html;
            #try_files $uri $uri/ /index.html;
            #auth_basic "secret";
            #auth_basic_user_file passwd.db;
            try_files $uri @prerender;
        }        

        location @prerender {
            #proxy_set_header X-Prerender-Token YOUR_TOKEN;
            
            set $prerender 0;
            if ($http_user_agent ~* "baiduspider|360spider|googlebot|twitterbot|facebookexternalhit|rogerbot|linkedinbot|embedly|quora link preview|showyoubot|outbrain|pinterest|slackbot|vkShare|W3C_Validator") {
                set $prerender 1;
            }
            if ($args ~ "_escaped_fragment_") {
                set $prerender 1;
            }
            if ($http_user_agent ~ "Prerender") {
                set $prerender 0;
            }
            if ($uri ~* "\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|svg|eot)") {
                set $prerender 0;
            }
            
            set $ismob 0;
            if ( $http_user_agent ~* '(Android|webOS|iPhone|iPod|iPad|BlackBerry|Mobile)' ){
                set $ismob 1;
            }
    
            if ($ismob = '1') {
                rewrite /news/detail/([0-9a-z]+) http://api.c-f.com/football/wemedia/posts/$1/html/share?key=visitor;
                rewrite /leader/detail/([0-9]+) http://api.c-f.com/football/games/staffs/$1/html/share?key=visitor;
                rewrite /coach/detail/([0-9]+) http://api.c-f.com/football/games/coaches/$1/html/share?key=visitor;
                rewrite /player/detail/([0-9]+) http://api.c-f.com/football/games/players/$1/html/share?key=visitor;
                rewrite /video/(.*)/(.*)/detail/([0-9]+)/([0-9a-z]+) http://s.files.c-f.com/templates/elearning/training/video.html?videoId=$4;
                rewrite /training/(.*)/text#([0-9a-z]+) http://s.files.c-f.com/templates/elearning/training/article.html?pageId=$2;
                rewrite /animate/(.*)/(.*)/detail/([0-9]+)/([0-9a-z]+) http://s.files.c-f.com/templates/elearning/training/exercise.html?exerciseId=$4;
                rewrite /download http://a.app.qq.com/o/simple.jsp?pkgname=com.l99.chinafootball;
                rewrite .* /index.html break;
                
            }
     
            if ($prerender = 1) {
                
                #setting prerender as a variable forces DNS resolution since nginx caches IPs and doesnt play well with load balancing
                #set $prerender "192.168.1.17:3000";
                rewrite .* /$scheme://$host$request_uri? break;
                #proxy_pass http://$prerender;
                proxy_pass http://prerender.c-f.com:3000;
            }
            if ($prerender = 0) {
                rewrite .* /index.html break;
            }
        }


        #error_page  404              /404.html;

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }

}
